<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Biên bản chứng kiến</title>
<script src="./pizzip.min.js"></script>
<script src="./docxtemplater.js"></script>
<script src="./FileSaver.min.js"></script>
</head>
<body>
<h3>2. Với sự chứng kiến của:</h3>

<label><input type="radio" name="loaiChungKien" value="canhan" checked> Cá nhân</label>
<label><input type="radio" name="loaiChungKien" value="coquan"> Cơ quan</label>
<label><input type="radio" name="loaiChungKien" value="ca2"> Cả hai</label>
<label><input type="radio" name="loaiChungKien" value="khongco"> Không có</label>

<hr>

<!-- CÁ NHÂN -->
<div id="formCanhan">
  <h4>Người chứng kiến (cá nhân)</h4>
  <div id="dsCanhan"></div>
  <button type="button" onclick="themNguoi()">+ Thêm người</button>
</div>

<!-- CƠ QUAN -->
<div id="formCoquan" style="display:none;">
  <h4>Cơ quan chứng kiến</h4>
  <div id="dsCoquan"></div>
  <button type="button" onclick="themCoquan()">+ Thêm cơ quan</button>
</div>

<hr>
<button id="downloadBtn">Tải Word</button>

<script>
let dsCanhan = [];
let dsCoquan = [];

// Hiện/ẩn form
document.querySelectorAll('input[name="loaiChungKien"]').forEach(radio => {
  radio.addEventListener('change', function() {
    const val = this.value;
    document.getElementById("formCanhan").style.display =
      (val === "canhan" || val === "ca2") ? "block" : "none";
    document.getElementById("formCoquan").style.display =
      (val === "coquan" || val === "ca2") ? "block" : "none";
  });
});

// ---------------------- THÊM + XOÁ NGƯỜI CÁ NHÂN ----------------------
function themNguoi() {
  const i = dsCanhan.length;
  const div = document.createElement("div");
  div.setAttribute("id", `nguoi_${i}`);
  div.innerHTML = `
    <fieldset style="margin:10px 0; padding:5px;">
    <legend>Người ${i + 1}</legend>
    <button type="button" onclick="xoaNguoi(${i})" style="float:right;">❌ Xóa</button><br>
    <label>Họ tên:</label><input id="hoten_${i}" type="text"><br>
    <label>Nghề nghiệp:</label><input id="nghenghiep_${i}" type="text"><br>
    
    <h5 style="margin-top:8px;">Địa chỉ</h5>
    <label>Tỉnh/Thành phố:</label>
    <select id="tinh_${i}" onchange="capNhatXa(${i})">
      <option value="">--Chọn tỉnh--</option>
      <option value="TP Hồ Chí Minh">TP Hồ Chí Minh</option>
      <option value="Hà Nội">Hà Nội</option>
      <option value="Đà Nẵng">Đà Nẵng</option>
      <option value="Cần Thơ">Cần Thơ</option>
      <option value="Khác">Khác</option>
    </select><br>
    <label>Xã/Phường:</label>
    <select id="xa_${i}">
      <option value="">--Chọn xã/phường--</option>
    </select><br>
    <label>Địa chỉ chi tiết:</label>
    <input id="diachi_${i}" type="text" placeholder="Số nhà, đường, khu vực..."><br>
    </fieldset>
  `;
  document.getElementById("dsCanhan").appendChild(div);
  dsCanhan.push(i);
}

function xoaNguoi(i) {
  const el = document.getElementById(`nguoi_${i}`);
  if (el) el.remove();
  dsCanhan = dsCanhan.filter(x => x !== i);
}

// ---------------------- THÊM + XOÁ CƠ QUAN ----------------------
function themCoquan() {
  const i = dsCoquan.length;
  const div = document.createElement("div");
  div.setAttribute("id", `coquan_${i}`);
  div.innerHTML = `
    <fieldset style="margin:10px 0; padding:5px;">
    <legend>Cơ quan ${i + 1}</legend>
    <button type="button" onclick="xoaCoquan(${i})" style="float:right;">❌ Xóa</button><br>
    <label>Họ và tên:</label><input id="tenNguoiCQ_${i}" type="text"><br>
    <label>Chức vụ:</label><input id="chucvuCQ_${i}" type="text"><br>
    <label>Cơ quan:</label><input id="tenCoquan_${i}" type="text"><br>
    </fieldset>
  `;
  document.getElementById("dsCoquan").appendChild(div);
  dsCoquan.push(i);
}

function xoaCoquan(i) {
  const el = document.getElementById(`coquan_${i}`);
  if (el) el.remove();
  dsCoquan = dsCoquan.filter(x => x !== i);
}

// ---------------------- DANH SÁCH XÃ ----------------------
const duLieuXa = {
  "TP Hồ Chí Minh": ["Phường 1", "Phường 2", "Phường 3"],
  "Hà Nội": ["Phường Ba Đình", "Phường Hoàn Kiếm"],
  "Đà Nẵng": ["Phường Hải Châu", "Phường Sơn Trà"],
  "Cần Thơ": ["Phường Ninh Kiều", "Phường Bình Thủy"],
  "Khác": ["Khác"]
};

function capNhatXa(i) {
  const tinh = document.getElementById(`tinh_${i}`).value;
  const xa = document.getElementById(`xa_${i}`);
  xa.innerHTML = '<option value="">--Chọn xã/phường--</option>';
  if (duLieuXa[tinh]) {
    duLieuXa[tinh].forEach(x => {
      const opt = document.createElement("option");
      opt.value = x;
      opt.textContent = x;
      xa.appendChild(opt);
    });
  }
}

// ---------------------- XUẤT WORD ----------------------
document.getElementById("downloadBtn").onclick = async function() {
  const loai = document.querySelector('input[name="loaiChungKien"]:checked').value;
  let data = {};

  if (loai === "khongco") {
    data.noidung = "………";
  } else {
    // Dữ liệu cá nhân
    const dsCanhanData = dsCanhan.map(i => ({
      hoten: document.getElementById(`hoten_${i}`).value,
      nghenghiep: document.getElementById(`nghenghiep_${i}`).value,
      diachi: `${document.getElementById(`diachi_${i}`).value}, ${document.getElementById(`xa_${i}`).value}, ${document.getElementById(`tinh_${i}`).value}`
    }));

    // Dữ liệu cơ quan
    const dsCoquanData = dsCoquan.map(i => ({
      hoten: document.getElementById(`tenNguoiCQ_${i}`).value,
      chucvu: document.getElementById(`chucvuCQ_${i}`).value,
      ten: document.getElementById(`tenCoquan_${i}`).value
    }));

    data.canhan = (loai === "canhan" || loai === "ca2") ? dsCanhanData : [];
    data.coquan = (loai === "coquan" || loai === "ca2") ? dsCoquanData : [];
  }

  const response = await fetch("template.docx");
  const arrayBuffer = await response.arrayBuffer();
  const zip = new PizZip(arrayBuffer);
  const doc = new window.docxtemplater(zip, {
    paragraphLoop: true,
    linebreaks: true,
    delimiters: { start: '<<', end: '>>' }
  });

  doc.setData({ chungkien: data });

  try {
    doc.render();
    const out = doc.getZip().generate({
      type: "blob",
      mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    });
    const blob = new Blob([out], { type: 
  "application/vnd.openxmlformats-officedocument.wordprocessingml.document" 
});
const url = window.URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url;
a.download = "BienBan.docx";
document.body.appendChild(a);
a.click();
a.remove();
window.URL.revokeObjectURL(url);

  } catch (e) {
    alert("Lỗi khi tạo Word: " + e.message);
  }
};
</script>
</body>
</html>
